---
layout: post
title:  shell多进程共享文件
date: 2021-01-02
tags: 博客
---

#### shell多个进程处理任务，共享一个任务列表

日志写到各自log文件，失败样本也写到各自文件。



	### config start ###
	run_parts_start=30
	run_parts_end=50
	hadoop_prefix=hdfs://xxx/part-00
	part_list_paths=./my_part_list
	thread_num=6
	### config end ###
	
	# init env
	if [ ! -d "failed_samples" ]; then
	  mkdir failed_samples
	fi
	
	if [ ! -d "multi_thread_logs" ]; then
	  mkdir multi_thread_logs
	fi
	
	rm -f failed_samples/*
	rm -f multi_thread_logs/*
	rm -f $part_list_paths
	
	function Get_part_list_paths() {
	    for idx in $(seq -f "%03g" $run_parts_start $run_parts_end)
	    do
	        #echo "process path:" ${hadoop_prefix}${idx} 
	        #hadoop fs -cat ${hadoop_prefix}${idx} | ./tdbank_insert
	        echo ${hadoop_prefix}${idx} >> $part_list_paths
	    done
	}
	
	function rand() {
	    min=$1
	    max=$(($2-$min+1))
	    num=$(($RANDOM+1000000000))
	    echo $(($num%$max+$min))
	}
	
	function Sub_thread() {
	    log_path=multi_thread_logs/sub_thread_${1}.log
	    while true
	    do
	        sleep $(rand 2 15) 
	        if [ $(wc -l < $part_list_paths) -le 0 ]; then
	            echo "sub_thread_${1} complete!"
	            break
	        fi 
	        my_part_name=$(flock -x -n $part_list_paths -c "echo $(head -1 $part_list_paths); sed -i '1d' $part_list_paths") 
	        if [ -z "$my_part_name" ]; then
	            echo $1 "part_name is empty, try again..."
	            continue
	        fi
	        
	        echo $1 $my_part_name
	        #echo "failed_sample_file_name:" failed_samples/failed_sample_thread_${1} >> $log_path
	        echo -n $(date '+[%Y/%m/%d %T]') >> $log_path
	        echo -e "\n" >> $log_path
	        echo $my_part_name >> $log_path
	        #sleep $(rand 10 20)
	        hadoop fs -cat ${my_part_name} | ./tdbank_insert failed_samples/failed_sample_thread_${1} >> $log_path
	        echo -e "\n****************************************************************\n" >> $log_path
	    done
	}
	
	function Multi_thread() {
	    for thread_idx in $(seq 1 $thread_num)
	    do
	        Sub_thread ${thread_idx} &
	    done
	    wait
	}
	
	# exec
	Get_part_list_paths
	Multi_thread
	
	
#### 多进程kill process

	#ps -efww | grep -w 'program_name' | grep -v grep | cut -c 9-15 | xargs kill -9

   
    

